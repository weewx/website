weewx station registry
24nov2013 mwall

this is a quick hack to enable weewx stations to phone home so they can be
plotted on a google map.  stations phone home periodically with their url,
location, lat/lon, and station type.  these data are plotted on a map.  if
a station does not phone home after a certain period of time it will be
removed from the map.

as of weewx 2.5, the client-side of station registry is included in the
weewx distribution in restful.py.


these are the server-side bits:

register.cgi - runs on the web server, accepts connections from stations

mkstations.pl - generate the html page by injecting station data into template

savecounts.pl - record changes to number and types of stations

archivelog.pl - rollover the register logfile

stations.html.in - template html page

crontab.reg - crontab entries for generating pages, log rollover, history


to configure the server:

1) install prerequisites

apt-get install libdbd-sqlite3-perl

2) install the cgi script

cp register.cgi /var/lib/cgi-bin

3) set up database location

mkdir /var/lib/weewx
chown www-data /var/lib/weewx

4) configure crontab to generate the html page

crontab -u www-data crontab.reg


#-----------------------------------------------
#----------- vds updates 2021-1015 -------------
#----------- for raspberry pi os   -------------
#-----------------------------------------------

To set up a clean raspberry pi with mysql, apache2, and the registration cgi:

1) install the required rpms

apt-get install libdbd-sqlite3-perl libdbd-mysal-perl mariadb-server

2)  create a /etc/weereg/dbinfo file ala the following example,
    substituting in your desired values

dbhost=localhost
dbname=weewx
dbuser=weewx
dbpass=weewx

3) enable cgi in apache2

cd /etc/apache2/mods-enabled
ln -s ../mods-available/cgi.load
service apache2 reload

4) set up mariadb user and database

create user 'weewx'@'localhost' identified by 'weewx';
create database weeex;
grant all privileges on weewx.* to 'weewx'@'localhost';

5) install the registration code and pages

cp register.pl /usr/lib/cgi-bin
copy everything else to /var/www/html/register

6) optional - install the crontab file

crontab -u www-data crontab.reg
and 'crontab -e' to edit the paths therein to taste


7a) test the registration - register a system

curl 'curl 'http://127.0.0.1/cgi-bin/register.cgi?station_url=http%3A%2F%2Fwww.somedomain.com&description=My+Little+Town%2C+Oregon&latitude=-71.123&longitude=123.345&station_type=whatever&station_model=something&python_info=3.7.1&platform_info=Linux-4.19.0-16-amd64-x86_64-with-debian-10.11'


7b) verify the database shows the newly registered system

# mysql -u weewx -p -h localhost
Enter password:
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 99
Server version: 10.3.31-MariaDB-0+deb10u1 Raspbian 10

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MariaDB [(none)]> use weewx
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
MariaDB [weewx]> select * from stations;
+-------------------------------+------------------------+----------+-----------+--------------+---------------+------------+-------------+------------------------------------------------+--------------------+-----------+------------+
| station_url                   | description            | latitude | longitude | station_type | station_model | weewx_info | python_info | platform_info                                  | entrypoint         | last_addr | last_seen  |
+-------------------------------+------------------------+----------+-----------+--------------+---------------+------------+-------------+------------------------------------------------+--------------------+-----------+------------+
| http://www23.example123a.com  | My Little Town, Oregon |  -11.123 |   112.345 | whatever     | Something2    | NULL       | 3.7.0       | Linux-4.19.0-16-amd64-x86_64-with-debian-10.11 | /usr/bin/weewxd    | 127.0.0.1 | 1634352207 |
+-------------------------------+------------------------+----------+-----------+--------------+---------------+------------+-------------+------------------------------------------------+--------------------+-----------+------------+
3 rows in set (0.000 sec)

MariaDB [weewx]> exit

